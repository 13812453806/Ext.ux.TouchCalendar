<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">/*
 * Ext.ux.TouchCalendarEvents
 */
Ext.define(&quot;Ext.ux.TouchCalendar&quot;,{extend:&quot;Ext.carousel.Carousel&quot;,xtype:&quot;calendar&quot;,enableSwipeNavigate:true,enableSimpleEvents:false,enableEventBars:false,viewConfig:{},defaultViewConfig:{viewMode:&quot;MONTH&quot;,weekStart:1,bubbleEvents:[&quot;selectionchange&quot;]},indicator:false,initialize:function(){this.viewConfig=Ext.applyIf(this.viewConfig||{},this.defaultViewConfig);this.viewConfig.currentDate=this.viewConfig.currentDate||this.viewConfig.value||new Date();this.viewMode=this.viewConfig.viewMode.toUpperCase();this.initViews();Ext.apply(this,{cls:&quot;touch-calendar&quot;,activeItem:(this.enableSwipeNavigate?1:0),direction:&quot;horizontal&quot;});this.setIndicator(false);this.setActiveItem(1);this.on(&quot;selectionchange&quot;,this.onSelectionChange);this.on(&quot;activeitemchange&quot;,this.onActiveItemChange);if(this.enableSwipeNavigate){this.on(this.element,{drag:this.onDrag,dragThreshold:5,dragend:this.onDragEnd,direction:this.direction,scope:this});this.element.addCls(this.baseCls+&quot;-&quot;+this.direction)}},getViewConfig:function(b){var a=[];if(this.enableSimpleEvents){a.push(new Ext.ux.TouchCalendarSimpleEvents())}else{if(this.enableEventBars){a.push(new Ext.ux.TouchCalendarEvents())}}Ext.apply(this.viewConfig,{plugins:a,currentDate:b,onTableHeaderTap:Ext.bind(this.onTableHeaderTap,this)});return this.viewConfig},getViewDate:function(a,b){var d=(this.viewMode===&quot;WEEK&quot;?&quot;DAY&quot;:this.viewMode.toUpperCase()),c=(this.viewMode===&quot;WEEK&quot;?(8*b):b);return Ext.Date.add(a,Ext.Date[d],c)},initViews:function(){var c=[];var f=Ext.Date.clone(this.viewConfig.currentDate),d=(this.enableSwipeNavigate?-1:0),a=(this.enableSwipeNavigate?1:0),b=[];var e=this.getViewDate(f,-1);c.push(new Ext.ux.TouchCalendarView(Ext.applyIf({currentDate:e},this.getViewConfig(e))));c.push(new Ext.ux.TouchCalendarView(this.getViewConfig(f)));e=this.getViewDate(f,1);c.push(new Ext.ux.TouchCalendarView(Ext.applyIf({currentDate:e},this.getViewConfig(e))));this.setItems(c);this.view=c[(this.enableSwipeNavigate?1:0)]},onTableHeaderTap:function(b,a){a=Ext.fly(a);if(a.hasCls(this.view.prevPeriodCls)||a.hasCls(this.view.nextPeriodCls)){this[(a.hasCls(this.view.prevPeriodCls)?&quot;prev&quot;:&quot;next&quot;)]()}},setMode:function(a){this.viewMode=a.toUpperCase();this.viewConfig.viewMode=this.viewMode;this.getItems().each(function(b,c){b.currentDate=this.getViewDate(Ext.Date.clone(this.view.currentDate),c-1);b.setViewMode(a,true);b.refresh()},this)},getValue:function(){var a=this.view.getSelectionModel().selected;return(a.getCount()&gt;0)?a.first().get(&quot;date&quot;):null},setValue:function(a){this.view.setValue(a)},onActiveItemChange:function(b,a,f){if(this.enableSwipeNavigate){var c=this.getItems();var e=c.indexOf(a),h=c.indexOf(f),g=(e&gt;h)?&quot;forward&quot;:&quot;backward&quot;;this.counter=(this.counter||0)+1;if(g===&quot;forward&quot;){this.remove(c.get(0));var d=new Ext.ux.TouchCalendarView(this.getViewConfig(Ext.Date.add(a.currentDate,Ext.Date[this.viewMode],1)));this.add(d)}else{this.remove(c.get(c.getCount()-1));var d=new Ext.ux.TouchCalendarView(this.getViewConfig(Ext.Date.add(a.currentDate,Ext.Date[this.viewMode],-1)));this.insert(0,d)}this.view=a}}});Ext.define(&quot;Ext.ux.TouchCalendarEvents&quot;,{extend:&quot;Ext.mixin.Observable&quot;,config:{eventBarTpl:&quot;{title}&quot;},startEventField:&quot;start&quot;,endEventField:&quot;end&quot;,colourField:&quot;colour&quot;,eventBarCls:&quot;event-bar&quot;,eventWrapperCls:&quot;event-wrapper&quot;,eventBarSelectedCls:&quot;event-bar-selected&quot;,cellHoverCls:&quot;date-cell-hover&quot;,autoUpdateEvent:true,allowEventDragAndDrop:false,eventBarSpacing:1,init:function(a){this.calendar=a;this.calendar.eventsPlugin=this;this.calendar.refresh=Ext.Function.createSequence(this.calendar.refresh,this.refreshEvents,this);this.calendar.afterComponentLayout=Ext.Function.createSequence(this.calendar.afterComponentLayout,this.refreshEvents,this)},refreshEvents:function(){this.removeEvents();this.generateEventBars();this.createEventWrapper();if(this.allowEventDragAndDrop){this.createDroppableRegion()}},createDroppableRegion:function(){var b=this;var a=0},onEventDropDeactivate:function(f,a,d,c){if(a.el.hasCls(this.eventBarCls)){var b=this.getEventRecord(a.el.getAttribute(&quot;eventID&quot;));this.calendar.element.select(&quot;div.&quot;+b.internalId).each(function(e){e.show()},this)}},onEventDrop:function(f,a,d,c){var b=false;if(a.el.hasCls(this.eventBarCls)){this.calendar.all.each(function(e){var j=e.getPageBox(true);var k=a.el.getPageBox(true);if(j.partial(k)&amp;&amp;this.calendar.fireEvent(&quot;beforeeventdrop&quot;,a,f,g,d)){b=true;var g=this.getEventRecord(a.el.getAttribute(&quot;eventID&quot;)),h=this.calendar.getCellDate(e),i=this.getDaysDifference(g.get(this.startEventField),h);if(this.autoUpdateEvent){g.set(this.startEventField,h);g.set(this.endEventField,g.get(this.endEventField).add(Date.DAY,i))}this.refreshEvents();this.calendar.fireEvent(&quot;eventdrop&quot;,a,f,g,d);return}},this);this.calendar.all.removeCls(this.cellHoverCls);if(!b){a.setOffset(a.startOffset,true)}}},generateEventBars:function(){this.eventBarStore=Ext.create(&quot;Ext.data.Store&quot;,{model:&quot;Ext.ux.CalendarEventBarModel&quot;,data:[]});var c=this.calendar.getStore();var a=this.calendar.eventStore;var b;c.each(function(e){var d=e.get(&quot;date&quot;),f=d.clearTime(true).getTime(),g=[];a.filterBy(function(i){var h=i.get(this.startEventField).clearTime(true).getTime(),j=i.get(this.endEventField).clearTime(true).getTime();return(h&lt;=f)&amp;&amp;(j&gt;=f)},this);a.sort(this.startEventField,&quot;ASC&quot;);a.each(function(i){var k=this.eventBarStore.findBy(function(l,m){return l.get(&quot;EventID&quot;)===i.internalId},this);if(k&gt;-1){b=this.eventBarStore.getAt(k);while(b.linked().getCount()&gt;0){b=b.linked().getAt(b.linked().getCount()-1)}if(d.getDay()===this.calendar.weekStart){g.push(b.get(&quot;BarPosition&quot;));var h=Ext.ModelMgr.create({EventID:i.internalId,Date:d,BarLength:1,BarPosition:b.get(&quot;BarPosition&quot;),Colour:b.get(&quot;Colour&quot;),Record:i},&quot;Ext.ux.CalendarEventBarModel&quot;);b.linked().add(h)}else{g.push(b.get(&quot;BarPosition&quot;));b.set(&quot;BarLength&quot;,b.get(&quot;BarLength&quot;)+1)}}else{var j=this.getNextFreePosition(g);g.push(j);b=Ext.ModelMgr.create({EventID:i.internalId,Date:d,BarLength:1,BarPosition:j,Colour:this.getRandomColour(),Record:i},&quot;Ext.ux.CalendarEventBarModel&quot;);this.eventBarStore.add(b)}},this);a.clearFilter()},this)},renderEventBars:function(a){var b=this;a.each(function(e){var j=this.getEventRecord(e.get(&quot;EventID&quot;)),h=this.calendar.getDateCell(e.get(&quot;Date&quot;)),g=this.eventBarDoesWrap(e),t=this.eventBarHasWrapped(e);var l=Ext.DomHelper.append(this.eventWrapperEl,{tag:&quot;div&quot;,style:{&quot;background-color&quot;:j.get(this.colourField)},html:new Ext.XTemplate(this.getEventBarTpl()).apply(j.data),eventID:e.get(&quot;EventID&quot;),cls:this.eventBarCls+&quot; &quot;+e.get(&quot;EventID&quot;)+(g?&quot; wrap-end&quot;:&quot;&quot;)+(t?&quot; wrap-start&quot;:&quot;&quot;)},true);if(this.allowEventDragAndDrop){new Ext.util.Draggable(l,{revert:true,onStart:function(z){var v=this,y=v.el.getAttribute(&quot;eventID&quot;),w=b.getEventRecord(y),x=b.getEventBarRecord(y);v.el.setWidth(v.el.getWidth()/x.get(&quot;BarLength&quot;));v.el.setLeft(z.startX-(v.el.getWidth()/2));b.calendar.element.select(&quot;div.&quot;+w.internalId).each(function(A){if(A.dom!==v.el.dom){A.hide()}},this);Ext.util.Draggable.prototype.onStart.apply(this,arguments);b.calendar.fireEvent(&quot;eventdragstart&quot;,v,w,z);return true}})}var s=this.calendar.element.select(&quot;thead&quot;).first().getHeight();var r=this.calendar.element.select(&quot;tbody&quot;).first().getHeight();var n=this.calendar.element.select(&quot;tbody tr&quot;).getCount();var d=r/n;var p=this.calendar.getStore().findBy(function(v){return v.get(&quot;date&quot;).getTime()===Ext.Date.clearTime(e.get(&quot;Date&quot;),true).getTime()},this);var o=Math.floor(p/7)+1;var q=s+(d*o);var u=e.get(&quot;BarPosition&quot;),k=e.get(&quot;BarLength&quot;),c=(this.calendar.element.getWidth()/7)*h.dom.cellIndex,i=h.getWidth(),m=l.getHeight(),f=this.eventBarSpacing;l.setLeft(c+(t?0:f));l.setTop(q-m-(u*m+(u*f)+f));l.setWidth((i*k)-(f*(g?(g&amp;&amp;t?0:1):2)));if(e.linked().getCount()&gt;0){this.renderEventBars(e.linked())}},this)},onEventDragStart:function(a,f){var d=a.el.getAttribute(&quot;eventID&quot;),b=this.getEventRecord(d),c=this.getEventBarRecord(d);a.el.setWidth(a.el.getWidth()/c.get(&quot;BarLength&quot;));a.updateBoundary(true);this.calendar.element.select(&quot;div.&quot;+b.internalId).each(function(e){if(e.dom!==a.el.dom){e.hide()}},this);this.calendar.fireEvent(&quot;eventdragstart&quot;,a,b,f)},eventBarDoesWrap:function(a){var b=a.get(&quot;Date&quot;).add(Date.DAY,(a.get(&quot;BarLength&quot;)-1));return b.clearTime(true).getTime()!==a.get(&quot;Record&quot;).get(this.endEventField).clearTime(true).getTime()},eventBarHasWrapped:function(a){return a.get(&quot;Date&quot;).clearTime(true).getTime()!==a.get(&quot;Record&quot;).get(this.startEventField).clearTime(true).getTime()},createEventWrapper:function(){if(this.calendar.rendered&amp;&amp;!this.eventWrapperEl){this.eventWrapperEl=Ext.DomHelper.append(this.getEventsWrapperContainer(),{tag:&quot;div&quot;,cls:this.eventWrapperCls},true);this.eventWrapperEl.on(&quot;tap&quot;,this.onEventWrapperTap,this,{delegate:&quot;div.&quot;+this.eventBarCls});this.renderEventBars(this.eventBarStore)}else{this.calendar.on(&quot;painted&quot;,this.createEventWrapper,this)}},onEventWrapperTap:function(d,c){d.stopPropagation();var b=c.attributes.eventID;if(b){var a=this.getEventRecord(c.attributes.eventID.value);this.deselectEvents();this.eventWrapperEl.select(&quot;div.&quot;+a.internalId).addCls(this.eventBarSelectedCls);this.calendar.fireEvent(&quot;eventtap&quot;,a,d)}},getEventsWrapperContainer:function(){return this.calendar.element.select(&quot;thead th&quot;).first()||this.calendar.element.select(&quot;tr td&quot;).first()},getNextFreePosition:function(a){var b=0;while(a.indexOf(b)&gt;-1){b++}return b},getEventRecord:function(a){var b=this.calendar.eventStore.findBy(function(c){return c.internalId===a},this);return this.calendar.eventStore.getAt(b)},getEventBarRecord:function(a){var b=this.eventBarStore.findBy(function(c){return c.get(&quot;EventID&quot;)===a},this);return this.eventBarStore.getAt(b)},deselectEvents:function(){this.calendar.element.select(&quot;.&quot;+this.eventBarSelectedCls).removeCls(this.eventBarSelectedCls)},getDaysDifference:function(b,a){b=b.clearTime(true).getTime();a=a.clearTime(true).getTime();return(a-b)/1000/60/60/24},removeEvents:function(){if(this.eventWrapperEl){this.eventWrapperEl.dom.innerHTML=&quot;&quot;;this.eventWrapperEl.destroy();this.eventWrapperEl=null}if(this.eventBarStore){this.eventBarStore.remove(this.eventBarStore.getRange());this.eventBarStore=null}if(this.droppable){this.droppable=null}},getRandomColour:function(){return&quot;#&quot;+(Math.random()*16777215&lt;&lt;0).toString(16)}});Ext.define(&quot;Ext.ux.CalendarEventBarModel&quot;,{extend:&quot;Ext.data.Model&quot;,config:{fields:[{name:&quot;EventID&quot;,type:&quot;string&quot;},{name:&quot;Date&quot;,type:&quot;date&quot;},{name:&quot;BarLength&quot;,type:&quot;int&quot;},{name:&quot;BarPosition&quot;,type:&quot;int&quot;},{name:&quot;Colour&quot;,type:&quot;string&quot;},&quot;Record&quot;],hasMany:[{model:&quot;Ext.ux.CalendarEventBarModel&quot;,name:&quot;linked&quot;}]}});Ext.define(&quot;Ext.util.Region.partial&quot;,{extend:&quot;Ext.util.Region&quot;,partial:function(g){var f=this,e=g.right-g.left,c=g.bottom-g.top,b=f.right-f.left,a=f.bottom-f.top,d=g.top&gt;f.top&amp;&amp;g.top&lt;f.bottom;horizontalValid=g.left&gt;f.left&amp;&amp;g.left&lt;f.right;return horizontalValid&amp;&amp;d}});</pre>
</body>
</html>
