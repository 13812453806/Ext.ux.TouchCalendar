<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='global-property-'>/**
</span> * @copyright 		(c) 2011, by SwarmOnline.com
 * @date      		2nd October 2011
 * @version   		0.1
 * @documentation	
 * @website	  		http://www.swarmonline.com
 */
<span id='Ext-ux-CalendarSimpleEvents'>/**
</span> * @class Ext.ux.CalendarSimpleEvents
 * @author Stuart Ashworth
 *
 * This plugin can be added to an Ext.ux.Calendar instance to allow a store to be bound to the calendar so events can be shown in a similar style to the iPhone
 * does with a dot added to each day to represent the presence of an event.
 * 
 * ![Ext.ux.CalendarSimpleEvents Screenshot](http://www.swarmonline.com/wp-content/uploads/Ext.ux.Calendar/Ext.ux.CalendarSimpleEvents-ss.png)
 * 
 * # Sample Usage
 * 
 *     Ext.regModel('Event', {
           fields: [{
               name: 'event',
               type: 'string'
           }, {
               name: 'location',
               type: 'string'
           }, {
               name: 'start',
               type: 'date',
               dateFormat: 'c'
           }, {
               name: 'end',
               type: 'date',
               dateFormat: 'c'
           }]
       });
       
       var calendar = new Ext.ux.Calendar({
           fullscreen: true,
           mode: 'month',
           weekStart: 1,
           value: new Date(),
           
           store: new Ext.data.Store({
		        model: 'Event',
		        data: [{
		            event: 'Sencha Con',
		            location: 'Austin, Texas',
		            start: new Date(2011, 9, 23),
		            end: new Date(2011, 9, 26)
		        }]
		    },
                        
           plugins: [new Ext.ux.CalendarSimpleEvents()]
       });
 *    
 * # Demo
 * [Ext.ux.CalendarSimpleEvents Demo](http://www.swarmonline.com/wp-content/uploads/Ext.ux.Calendar/examples/Ext.ux.CalendarSimpleEvents.html)
 */
Ext.ux.CalendarSimpleEvents = Ext.extend(Ext.util.Observable, {
	
<span id='Ext-ux-CalendarSimpleEvents-cfg-dateField'>	/**
</span>	 * @cfg {Date} dateField Name of the field which contains the Event's date
	 */
	dateField: 'start',
	
<span id='Ext-ux-CalendarSimpleEvents-cfg-multiEventDots'>	/**
</span>	 * @cfg {Boolean} multiEventDots True to display a dot for each event on a day. False to only show one dot regardless
	 * of how many events there are
	 */
	multiEventDots: true,
	
<span id='Ext-ux-CalendarSimpleEvents-cfg-wrapperCls'>	/**
</span>	 * @cfg {String} wrapperCls CSS class that is added to the event dots' wrapper element
	 */
	wrapperCls: 'simple-event-wrapper',
	
<span id='Ext-ux-CalendarSimpleEvents-cfg-eventDotCls'>	/**
</span>	 * @cfg {String} eventDotCls CSS class that is added to the event dot element itself. Used to provide
	 * the dots' styling
	 */
	eventDotCls: 'simple-event',
	
<span id='Ext-ux-CalendarSimpleEvents-cfg-dotWidth'>	/**
</span>	 * @cfg {Number} dotWidth Width in pixels of the dots as defined by CSS. This is used for calculating the positions and
	 * number of dots able to be shown.
	 */
	dotWidth: 6,
	
<span id='Ext-ux-CalendarSimpleEvents-cfg-eventTpl'>	/**
</span>	 * @cfg {Ext.XTemplate} eventTpl Template used to create the Event markup. Template is merged with the records left
	 * following the filter
	 * 
	 */
	eventTpl: new Ext.XTemplate(
	'&lt;span class=&quot;{wrapperCls}&quot;&gt;',
		'&lt;tpl for=&quot;events&quot;&gt;',
			'&lt;span class=&quot;{[parent.eventDotCls]}&quot;&gt;&lt;/span&gt;',
		'&lt;/tpl&gt;',
	'&lt;/span&gt;'),
	
<span id='Ext-ux-CalendarSimpleEvents-method-filterFn'>	/**
</span>	 * Function used to filter the store for each of the displayed dates
	 * @method
	 * @private
	 * @param {Object} record - current record
	 * @param {Object} id - ID of passed in record
	 * @param {Object} currentDate - date we are currently dealing while looping Calendar's dateCollection property
	 */
	filterFn: function(record, id, currentDate){
		return record.get(this.dateField).clearTime(true).getTime() === currentDate.clearTime(true).getTime();
	},
	
	init: function(calendar){
		
		this.calendar = calendar; // cache the parent calendar
		this.calendar.simpleEventsPlugin = this; // cache the plugin instance on the calendar itself
		
		this.wrapperCls = this.wrapperCls + (this.multiEventDots ? '-multi' : '');
		this.eventDotCls = this.eventDotCls + (this.multiEventDots ? '-multi' : '');
		
		this.calendar.showEvents = this.showEvents;
		this.calendar.hideEvents = this.hideEvents;
		this.calendar.removeEvents = this.removeEvents;
		
		// listen to the Calendar's 'refresh' event and render events when it fires
		this.calendar.on({
			refresh: this.renderEvents,
			initialrender: this.renderEvents,
			scope: this
		});
	},
	
<span id='Ext-ux-CalendarSimpleEvents-method-renderEvents'>	/**
</span>	 * Function to execute when the Calendar is refreshed.
	 * It loops through the Calendar's current dateCollection and gets all Events
	 * for the current date and inserts the appropriate markup
	 * @method
	 * @private
	 * @return {void}
	 */
	renderEvents: function(){
		if (!this.disabled) {
			var dc = this.calendar.dateCollection;

			if (dc) {
				// loop through Calendar's current dateCollection
				dc.each(function(dateObj){
					var date = dateObj.date;
					
					var cell = this.calendar.getDateCell(date); // get the table cell for the current date
					var store = this.calendar.store;
					
					if (cell) {
						store.clearFilter();

						// if we only want to show a single dot per day then use findBy for better performance
						var matchIndex = store[this.multiEventDots ? 'filterBy' : 'findBy'](Ext.createDelegate(this.filterFn, this, [date], true));
						var eventCount = store.getRange().length;
						
						if ((!this.multiEventDots &amp;&amp; matchIndex &gt; -1) || (this.multiEventDots &amp;&amp; eventCount &gt; 0)) {
							// get maximum number of dots that can fitted in the cell
							var maxDots = Math.min((cell.getWidth()/this.dotWidth), eventCount);
							
							// append the event markup
							var t = this.eventTpl.append(cell, {
								events: (this.multiEventDots ? store.getRange().slice(0, maxDots) : ['event']),
								wrapperCls: this.wrapperCls,
								eventDotCls: this.eventDotCls
							}, true);
							
							// position the dot wrapper based on the cell dimensions and dot count
							t.setWidth(Math.min((this.multiEventDots ? store.getRange().length : 1) * this.dotWidth, cell.getWidth()));
							t.setY((cell.getY() + cell.getHeight()) - (t.getHeight() + (cell.getHeight()*0.1)) );
							t.setX((cell.getX() + (cell.getWidth()/2)) - (t.getWidth()/2) );
						}
					}
				}, this);
			}
		}
	},
	
<span id='Ext-ux-CalendarSimpleEvents-method-hideEvents'>	/**
</span>	 * Hides all the event markers
	 * This is added to the parent Calendar's class so must be executed via the parent
	 * @method
	 * @return {void}
	 */
	hideEvents: function(){
		this.simpleEventsPlugin.disabled = true;
		
		this.body.select('span.' + this.wrapperCls).hide();
	},
	
<span id='Ext-ux-CalendarSimpleEvents-method-showEvents'>	/**
</span>	 * Shows all the event markers
	 * This is added to the parent Calendar's class so must be executed via the parent
	 * @method
	 * @return {void}
	 */
	showEvents: function(){
		this.simpleEventsPlugin.disabled = false;
		
		this.body.select('span.' + this.wrapperCls).show();
	},
	
<span id='Ext-ux-CalendarSimpleEvents-method-removeEvents'>	/**
</span>	 * Removes all the event markers and their markup
	 * This is added to the parent Calendar's class so must be executed via the parent
	 * @method
	 * @return {void}
	 */
	removeEvents: function(){
		this.body.select('span.' + this.wrapperCls).remove();
	}	
});
</pre>
</body>
</html>
