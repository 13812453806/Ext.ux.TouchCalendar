Ext.ns("Ext.ux");Ext.ux.Calendar=Ext.extend(Ext.Panel,{cls:"ux-calendar",autoHeight:true,value:new Date(),weekStart:1,minDate:null,maxDate:null,fullHeight:true,moveToMonthOnDateTap:false,todayCls:"today",selectedCls:"selected",unselectableCls:"unselectable",prevMonthCls:"prev-month",nextMonthCls:"next-month",weekendCls:"weekend",prevPeriodCls:"goto-prev",nextPeriodCls:"goto-next",commonTemplateFunctions:{getClasses:function(a){var b=[];if(a.selected){b.push(this.me.selectedCls)}if(a.unselectable){b.push(this.me.unselectableCls)}if(a.prevMonth){b.push(this.me.prevMonthCls)}if(a.nextMonth){b.push(this.me.nextMonthCls)}if(a.weekend){b.push(this.me.weekendCls)}if(a.today){b.push(this.me.todayCls)}return b.join(" ")},isEndOfRow:function(a){return(a%7)===0&&(a>0)},isEndOfPeriod:function(a){return a===this.me.totalDays[this.me.mode](this.me.value)},getDaysArray:function(a){var c=[],b;for(b=0;b<7;b++){c.push(a.dates[b])}return c},getHeaderClass:function(a){return a===1?this.me.prevPeriodCls:a===7?this.me.nextPeriodCls:""}},constructor:function(a){this.tpl=new Ext.XTemplate('<table class="{[this.me.mode]}">',"<thead>","<tr>",'<tpl for="this.getDaysArray(values)">','<th class="{[this.getHeaderClass(xindex)]}">','<tpl if="xindex === 4">','<span>{[parent.currentDate.format("F")]} {[parent.currentDate.format("Y")]}</span>',"</tpl>",'{date:date("D")}',"</th>","</tpl>","</tr>","</thead>","<tbody>","<tr>",'<tpl for="dates">','<td class="day {[this.getClasses(values)]}" datetime="{[this.me.getDateAttribute(values.date)]}">','{date:date("j")}',"</td>",'<tpl if="this.isEndOfRow(xindex)">',"</tr>",'<tpl if="!this.isEndOfPeriod(xindex)">',"<tr>","</tpl>","</tpl>","</tpl>","</tr>","</tbody>","</table>",Ext.apply(this.commonTemplateFunctions,{me:this}));Ext.apply(this,a||{});this.addEvents("refresh","initialrender","selectionchange","periodchange");Ext.ux.Calendar.superclass.constructor.call(this,a);this.minDate=this.minDate?this.minDate.clearTime(true):null;this.maxDate=this.maxDate?this.maxDate.clearTime(true):null},initComponent:function(){Ext.apply(this,{totalDays:{month:function(a){var b=a.getFirstDateOfMonth();return this.isWeekend(b)?42:35},week:function(a){return 7}},modeStartFns:{month:this.getMonthStartDate,week:this.getWeekStartDate},modeDeltaFns:{month:this.getMonthDeltaDate,week:this.getWeekDeltaDate}});Ext.ux.Calendar.superclass.initComponent.call(this);this.previousValue=this.value;this.on("afterrender",Ext.createDelegate(this.refresh,this,[true],false),this)},onRender:function(b,a){Ext.ux.Calendar.superclass.onRender.apply(this,arguments);this.body.on({click:this.onDayTap,scope:this,delegate:"td"});this.body.on({click:this.onTableHeaderTap,scope:this,delegate:"th"})},setMode:function(a){this.mode=a;this.refresh()},syncHeight:function(){if(this.fullHeight){this.body.down("table").setHeight(this.body.getHeight())}},refresh:function(a){this.currentDate=this.currentDate||this.value||new Date();this.dateCollection=this.getDateCollection(this.currentDate.getDate(),this.currentDate.getMonth(),this.currentDate.getFullYear());this.update({currentDate:this.currentDate,dates:this.dateCollection.items});this.body.getHeight();this.syncHeight();this.dateCellEls=this.body.select("td.day");if(a){this.fireEvent("initialrender",this)}else{this.fireEvent("refresh",this)}},onDayTap:function(b,a){a=Ext.fly(a);if(!a.hasCls(this.unselectableCls)){this.setValue(this.getCellDate(a))}},onTableHeaderTap:function(b,a){a=Ext.fly(a);if(a.hasCls(this.prevPeriodCls)||a.hasCls(this.nextPeriodCls)){this.refreshDelta(a.hasCls(this.prevPeriodCls)?-1:1)}},setValue:function(a){if(!this.isSameDay(this.value,a)){this.previousValue=this.value;if(Ext.isDate(a)){this.value=a}else{this.value=null}if(this.value){this.currentDate=this.value;this.selectDate(this.value)}}},selectDate:function(a){var b=false;this.removeSelectedCell();this.body.select("td").each(function(d){var c=this.getCellDate(d);if(((!d.hasCls(this.prevMonthCls)&&!d.hasCls(this.nextMonthCls))||!this.moveToMonthOnDateTap)&&this.isSameDay(a,c)){d.addCls(this.selectedCls);if((this.value&&this.previousValue)&&!this.isSameDay(this.value,this.previousValue)){this.fireEvent("selectionchange",this,this.previousValue,this.value)}b=true}},this);if(!b){this.refresh()}},refreshDelta:function(d){var b=this.currentDate||new Date();var a=this.modeDeltaFns[this.mode](b,d);if(this.isOutsideMinMax(a)){return}this.currentDate=a;this.refresh();var c=this.getPeriodMinMaxDate();this.fireEvent("periodchange",this,c.min.date,c.max.date,(d>0?"forward":"back"))},getPeriodMinMaxDate:function(){return{min:this.dateCollection.first(),max:this.dateCollection.last()}},isOutsideMinMax:function(a){var b=false;if(this.mode==="month"){b=((this.minDate&&a.getLastDateOfMonth()<this.minDate)||(this.maxDate&&a.getFirstDateOfMonth()>this.maxDate))}else{b=((this.minDate&&this.getWeekEndDate(a.getDate(),a.getMonth(),a.getFullYear())<this.minDate)||(this.maxDate&&this.getWeekStartDate(a.getDate(),a.getMonth(),a.getFullYear())>this.maxDate))}return b},removeSelectedCell:function(){this.body.select("."+this.selectedCls).removeCls(this.selectedCls)},getDateCollection:function(j,e,f){var c=new Ext.util.MixedCollection(),d=true,a=new Date(f,e,j),h=Ext.createDelegate(this.modeStartFns[this.mode],this)(j,e,f),g=Ext.createDelegate(this.totalDays[this.mode],this)(a);for(var b=0;b<g;b++){h=new Date(h.getFullYear(),h.getMonth(),h.getDate()+(b===0?0:1));d=(this.minDate&&h<this.minDate)||(this.maxDate&&h>this.maxDate);c.add({today:this.isSameDay(h,new Date()),unselectable:d,selected:this.isSameDay(h,this.value)&&!d,prevMonth:(h.getMonth()<a.getMonth()),nextMonth:(h.getMonth()>a.getMonth()),weekend:this.isWeekend(h),date:h})}return c},getMonthStartDate:function(a,c,b){return this.getWeekStartDate(1,c,b)},getWeekStartDate:function(c,e,d){var a=new Date(d,e,c);var b=a.getDay()-this.weekStart;b=b<0?6:b;return new Date(a.getFullYear(),a.getMonth(),a.getDate()-0-b)},getWeekEndDate:function(c,e,d){var a=new Date(d,e,c);var b=a.getDay()-this.weekStart;b=b<0?6:b;return new Date(a.getFullYear(),a.getMonth(),a.getDate()+0+b)},getMonthDeltaDate:function(b,d){var c=b.getMonth()+d,a=new Date(b.getFullYear(),c,1);a.setDate(a.getDaysInMonth()<b.getDate()?a.getDaysInMonth():b.getDate());return a},getWeekDeltaDate:function(a,b){return new Date(a.getFullYear(),a.getMonth(),a.getDate()+(b*7))},isSameDay:function(b,a){return b.clearTime(true).getTime()===a.clearTime(true).getTime()},isWeekend:function(a){return a.getDay()===0||a.getDay()===6},getCellDate:function(b){var a=b.dom.getAttribute("datetime");return this.stringToDate(a)},getDateCell:function(a){return this.body.select('td[datetime="'+this.getDateAttribute(a)+'"]').first()},getDateAttribute:function(a){return a.format("Y-m-d")},stringToDate:function(a){return Date.parseDate(a,"Y-m-d")}});Ext.ux.CalendarSimpleEvents=Ext.extend(Ext.util.Observable,{dateField:"start",multiEventDots:false,wrapperCls:"simple-event-wrapper",eventDotCls:"simple-event",eventTpl:new Ext.XTemplate('<span class="{wrapperCls}">','<tpl for="events">','<span class="{[parent.eventDotCls]}"></span>',"</tpl>","</span>"),filterFn:function(b,c,a){return b.get(this.dateField).clearTime(true).getTime()===a.clearTime(true).getTime()},init:function(a){this.calendar=a;this.calendar.simpleEventsPlugin=this;this.wrapperCls=this.wrapperCls+(this.multiEventDots?"-multi":"");this.eventDotCls=this.eventDotCls+(this.multiEventDots?"-multi":"");this.calendar.showEvents=this.showEvents;this.calendar.hideEvents=this.hideEvents;this.calendar.removeEvents=this.removeEvents;this.calendar.on({refresh:this.renderEvents,initialrender:this.renderEvents,scope:this})},renderEvents:function(){if(!this.disabled){var a=this.calendar.dateCollection;if(a){a.each(function(d){var f=d.date;var c=this.calendar.getDateCell(f);var e=this.calendar.store;if(c){e.clearFilter();var b=e[this.multiEventDots?"filterBy":"findBy"](Ext.createDelegate(this.filterFn,this,[f],true));if((!this.multiEventDots&&b>-1)||(this.multiEventDots&&e.getRange().length>0)){var g=this.eventTpl.append(c,{events:(this.multiEventDots?e.getRange():["event"]),wrapperCls:this.wrapperCls,eventDotCls:this.eventDotCls},true)}}},this)}}},hideEvents:function(){this.simpleEventsPlugin.disabled=true;this.body.select("span."+this.wrapperCls).hide()},showEvents:function(){this.simpleEventsPlugin.disabled=false;this.body.select("span."+this.wrapperCls).show()},removeEvents:function(){this.body.select("span."+this.wrapperCls).remove()}});