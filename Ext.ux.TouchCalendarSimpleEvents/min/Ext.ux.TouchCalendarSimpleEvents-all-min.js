Ext.ux.TouchCalendar=Ext.extend(Ext.Carousel,{enableSwipeNavigate:true,enableSimpleEvents:false,enableEventBars:false,viewConfig:{},defaultViewConfig:{mode:"MONTH",weekStart:1,bubbleEvents:["selectionchange"]},indicator:false,initComponent:function(){this.viewConfig=Ext.applyIf(this.viewConfig||{},this.defaultViewConfig);this.viewConfig.currentDate=this.viewConfig.currentDate||this.viewConfig.value||new Date();this.mode=this.viewConfig.mode.toUpperCase();this.initViews();Ext.apply(this,{cls:"touch-calendar",activeItem:(this.enableSwipeNavigate?1:0),direction:"horizontal"});Ext.ux.TouchCalendar.superclass.initComponent.call(this);this.on("selectionchange",this.onSelectionChange)},getViewConfig:function(b){var a=[];if(this.enableSimpleEvents){a.push(new Ext.ux.TouchCalendarSimpleEvents())}else{if(this.enableEventBars){a.push(new Ext.ux.TouchCalendarEvents())}}Ext.apply(this.viewConfig,{plugins:a,currentDate:b,onTableHeaderTap:Ext.createDelegate(this.onTableHeaderTap,this)});return this.viewConfig},getViewDate:function(a,b){var d=(this.mode==="WEEK"?"DAY":this.mode.toUpperCase()),c=(this.mode==="WEEK"?(8*b):b);return a.add(Date[d],c)},initViews:function(){this.items=[];var e=this.viewConfig.currentDate.clone(),c=(this.enableSwipeNavigate?-1:0),a=(this.enableSwipeNavigate?1:0),b=[];var d=this.getViewDate(e,-1);this.items.push(new Ext.ux.TouchCalendarView(Ext.applyIf({currentDate:d},this.getViewConfig(d))));this.items.push(new Ext.ux.TouchCalendarView(this.getViewConfig(e)));d=this.getViewDate(e,1);this.items.push(new Ext.ux.TouchCalendarView(Ext.applyIf({currentDate:d},this.getViewConfig(d))));this.view=this.items[(this.enableSwipeNavigate?1:0)]},onTableHeaderTap:function(b,a){a=Ext.fly(a);if(a.hasCls(this.view.prevPeriodCls)||a.hasCls(this.view.nextPeriodCls)){this[(a.hasCls(this.view.prevPeriodCls)?"prev":"next")]()}},setMode:function(a){this.mode=a.toUpperCase();this.viewConfig.mode=this.mode;this.items.each(function(b,c){b.currentDate=this.getViewDate(this.view.currentDate.clone(),c-1);b.setMode(a,true);b.refresh()},this)},getValue:function(){var a=this.view.getSelectionModel().selected;return(a.getCount()>0)?a.first().get("date"):null},setValue:function(a){this.view.setValue(a)},afterRender:function(){Ext.Carousel.superclass.afterRender.call(this);if(this.enableSwipeNavigate){this.mon(this.body,{drag:this.onDrag,dragThreshold:5,dragend:this.onDragEnd,direction:this.direction,scope:this});this.el.addCls(this.baseCls+"-"+this.direction)}},onCardSwitch:function(a,d,b,e){if(this.enableSwipeNavigate){var c=this.items.indexOf(a),g=this.items.indexOf(d),f=(c>g)?"forward":"backward";this.counter=(this.counter||0)+1;if(f==="forward"){this.remove(this.items.get(0));this.add(new Ext.ux.TouchCalendarView(this.getViewConfig(a.currentDate.add(Date[this.mode],1))))}else{this.remove(this.items.get(this.items.getCount()-1));this.insert(0,new Ext.ux.TouchCalendarView(this.getViewConfig(a.currentDate.add(Date[this.mode],-1))))}this.doLayout();this.view=a}Ext.ux.TouchCalendar.superclass.onCardSwitch.apply(this,arguments)}});Ext.ux.TouchCalendarSimpleEvents=Ext.extend(Ext.util.Observable,{startEventField:"start",endEventField:"end",multiEventDots:true,wrapperCls:"simple-event-wrapper",eventDotCls:"simple-event",dotWidth:6,eventTpl:new Ext.XTemplate('<span class="{wrapperCls}">','<tpl for="events">','<span class="{[parent.eventDotCls]}"></span>',"</tpl>","</span>"),filterFn:function(c,e,b){var a=c.get(this.startEventField).clearTime(true).getTime(),d=c.get(this.endEventField).clearTime(true).getTime(),b=b.clearTime(true).getTime();return(a<=b)&&(d>=b)},init:function(a){this.calendar=a;this.calendar.simpleEventsPlugin=this;this.wrapperCls=this.wrapperCls+(this.multiEventDots?"-multi":"");this.eventDotCls=this.eventDotCls+(this.multiEventDots?"-multi":"");this.calendar.showEvents=this.showEvents;this.calendar.hideEvents=this.hideEvents;this.calendar.removeEvents=this.removeEvents;this.calendar.syncHeight=Ext.createSequence(this.calendar.syncHeight,this.refreshEvents,this)},refreshEvents:function(){if(!this.disabled){var a=this.calendar.store;if(a&&this.calendar.isVisible()){this.removeEvents();a.each(function(d){var f=d.get("date");var c=this.calendar.getDateCell(f);var e=this.calendar.eventStore;if(c){e.clearFilter();var b=e[this.multiEventDots?"filterBy":"findBy"](Ext.createDelegate(this.filterFn,this,[f],true));var i=e.getRange().length;if((!this.multiEventDots&&b>-1)||(this.multiEventDots&&i>0)){var h=Math.min((c.getWidth()/this.dotWidth),i);var g=this.eventTpl.append(c,{events:(this.multiEventDots?e.getRange().slice(0,h):["event"]),wrapperCls:this.wrapperCls,eventDotCls:this.eventDotCls},true);g.setWidth(Math.min((this.multiEventDots?e.getRange().length:1)*this.dotWidth,c.getWidth()));g.setY((c.getY()+c.getHeight())-(g.getHeight()+(c.getHeight()*0.1)));g.setX((c.getX()+(c.getWidth()/2))-(g.getWidth()/2))}}},this)}}},hideEvents:function(){this.simpleEventsPlugin.disabled=true;this.calendar.el.select("span."+this.wrapperCls).hide()},showEvents:function(){this.simpleEventsPlugin.disabled=false;this.calendar.el.select("span."+this.wrapperCls).show()},removeEvents:function(){if(this.calendar.el){this.calendar.el.select("span."+this.wrapperCls).remove()}}});